name: "Delete GitHub Workflow Runs"

description: 'Delete GitHub Action workflow runs'

author: tagdots

branding:
  icon: trash-2
  color: green

inputs:
  dry-run:
    description: 'Dry Run'
    default: 'true'
    required: false

  min-runs:
    description: 'Minimum number of runs to keep in each workflow'
    required: false

  max-days:
    description: 'Maximum number of days to keep runs in each workflow'
    required: false

  repo-url:
    description: 'Repository URL'
    default: ${{ github.server_url }}/${{ github.repository }}
    required: true

runs:
  using: "composite"

  steps:

  - name: Checkout source code
    uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

  - name: Install Python
    uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
    with:
      python-version: '3.14.x'

  - name: Install the latest delete-workflow-runs
    shell: bash
    run: python -m pip install -U delete-workflow-runs

  - name: Run delete-workflow-runs to show version
    shell: bash
    run: delete-workflow-runs --version

  - name: Check for mutually exclusive options
    shell: bash
    env:
      INPUT_MIN_RUNS: "${{ inputs.min-runs }}"
      INPUT_MAX_DAYS: "${{ inputs.max-days }}"
    run: |
      # check for mutually exclusive options
      if [[ -n "$INPUT_MAX_DAYS" && -n "$INPUT_MIN_RUNS" ]]; then
        echo "Error: max-days A and min-runs are mutually exclusive. Please select only one."
        exit 1
      fi
      if [[ -z "$INPUT_MAX_DAYS" && -z "$INPUT_MIN_RUNS" ]]; then
        echo "Error: At least one option (max-days or min-runs) must be selected."
        exit 1
      fi

  - name: Run delete-workflow-runs (max-days)
    shell: bash
    env:
      INPUT_DRY_RUN: "${{ inputs.dry-run }}"
      INPUT_MAX_DAYS: "${{ inputs.max-days }}"
      INPUT_REPO_URL: "${{ inputs.repo-url }}"
    run: |
      # delete-workflow-runs (max-days)
      if [[ -n "$INPUT_MAX_DAYS" && "$INPUT_MAX_DAYS" -ge 0 ]]; then
        COLUMNS=145 delete-workflow-runs \
          --dry-run "$INPUT_DRY_RUN" \
          --repo-url "$INPUT_REPO_URL" \
          --max-days "$INPUT_MAX_DAYS"
      fi

  - name: Run delete-workflow-runs (min-runs)
    shell: bash
    env:
      INPUT_DRY_RUN: "${{ inputs.dry-run }}"
      INPUT_MIN_RUNS: "${{ inputs.min-runs }}"
      INPUT_REPO_URL: "${{ inputs.repo-url }}"
    run: |
      # delete-workflow-runs (min-runs)
      if [[ -n "$INPUT_MIN_RUNS" && "$INPUT_MIN_RUNS" -ge 0 ]]; then
        COLUMNS=145 delete-workflow-runs \
          --dry-run "$INPUT_DRY_RUN" \
          --repo-url "$INPUT_REPO_URL" \
          --min-runs "$INPUT_MIN_RUNS"
      fi
